---
# Pre upgrade step required by this automation to disable unsubscription from
# RHEL during the upgrade.

- name: Write out environment file to disable rhel registration deletion
  copy:
    dest: /home/stack/environments/no_delete_rhelsub.yaml
    content: |
      parameter_defaults:
        DeleteOnRHELUnregistration: false

- name: Write out networking-cisco specific config environment resources
  copy:
    dest: /home/stack/environments/networking-cisco-config-resources-preupgrade.yaml
    content: |
      resource_registry:
        OS::TripleO::NodeUserData: /usr/share/openstack-tripleo-heat-templates/firstboot/os-net-config-mappings.yaml
        OS::TripleO::ControllerExtraConfigPre: /home/stack/templates/controller_extra_config_prepuppet.yaml

- name: Update the current plan using your original openstack overcloud deploy command
  shell: |
    source /home/stack/stackrc
    openstack overcloud deploy --update-plan-only --templates \
        -e /home/stack/environments/overcloud-config.yaml \
        -e /usr/share/openstack-tripleo-heat-templates/environments/network-isolation.yaml \
        -e /usr/share/openstack-tripleo-heat-templates/environments/net-single-nic-with-vlans.yaml \
        -e /home/stack/environments/networking-cisco-config-resources-preupgrade.yaml \
        -e /home/stack/environments/networking-cisco-config-params.yaml \
        -e /home/stack/environments/no_delete_rhelsub.yaml \
        -e /home/stack/environments/rhel_sub_config.yaml \
        -e /usr/share/openstack-tripleo-heat-templates/extraconfig/pre_deploy/rhel-registration/rhel-registration-resource-registry.yaml \
        --ntp-server 1.ntp.esl.cisco.com

- name: Install expect package
  yum:
    name: expect
    state: latest
  become: true

- name: Perform a stack update to ensure that the rhelsub changes are picked up
  shell: |
    set timeout -1
    set end -1;

    spawn /bin/bash -c "source /home/stack/stackrc && openstack overcloud update stack -i overcloud"

    while {$end == -1} {
       expect {
           "Breakpoint reached" { send -- "\r" }
           "update finished with status COMPLETE" { set end [ expr $end + 1 ] }
           "update finished with status FAILED" { set end [ expr $end + 2 ] }
       }
    }

    exit $end
  args:
    executable: /usr/bin/expect


# 3.1. UPGRADING THE UNDERCLOUD TO OPENSTACK PLATFORM 11

- name: Disable the OSP10 repo
  rhsm_repository:
    name: rhel-7-server-openstack-10-rpms
    state: disabled
  become: true

- name: Enable the OSP11 repo
  rhsm_repository:
    name: rhel-7-server-openstack-11-rpms
    state: present
  become: true

- name: Stop the main OpenStack Platform services
  systemd:
    state: stopped
    name: "{{ item }}"
  with_items:
    - 'openstack-*'
    - 'neutron-*'
    - httpd
  become: true

- name: Upgrade the director's main packages
  yum:
    name: '{{ item }}'
    state: latest
    update_cache: true
  with_items:
    - instack-undercloud
    - openstack-puppet-modules
    - openstack-tripleo-common
    - python-tripleoclient
  become: true

- name: Upgrade the undercloud
  shell: openstack undercloud upgrade

# 3.2. UPGRADING THE UNDERCLOUD TO OPENSTACK PLATFORM 12

- name: Disable the OSP11 repo
  rhsm_repository:
    name: rhel-7-server-openstack-11-rpms
    state: disabled
  become: true

- name: Enable the OSP12 repo
  rhsm_repository:
    name: rhel-7-server-openstack-12-rpms
    state: present
  become: true

- name: Upgrade the director's main packages
  yum:
    name: python-tripleoclient
    state: latest
    update_cache: true
  become: true

- name: Upgrade the undercloud
  shell: openstack undercloud upgrade

# 3.3. UPGRADING THE UNDERCLOUD TO OPENSTACK PLATFORM 13

- name: Disable the OSP12 repo
  rhsm_repository:
    name: rhel-7-server-openstack-12-rpms
    state: disabled
  become: true

- name: Enable the OSP13 repo
  rhsm_repository:
    name: rhel-7-server-openstack-13-rpms
    state: present
  become: true

- name: Upgrade the director's main packages
  yum:
    name: python-tripleoclient
    state: latest
    update_cache: true
  become: true

- name: Upgrade the undercloud
  shell: openstack undercloud upgrade

- name: Reboot the undercloud to update the system
  shell: "sleep 5 && reboot"
  async: 1
  poll: 0
  become: true

- name: Wait for director to finish rebooting
  wait_for_connection:
    connect_timeout: 20
    sleep: 5
    delay: 20
    timeout: 600

# 4.5. USING THE UNDERCLOUD AS A LOCAL REGISTRY

- name: Create a template to upload the the images to the local registry
  shell: |
    source /home/stack/stackrc
    openstack overcloud container image prepare \
    --namespace=registry.access.redhat.com/rhosp13 \
    --push-destination={{ undercloud_local_ip | ipaddr('address') }}:8787 \
    --prefix=openstack- \
    --tag-from-label {version}-{release} \
    --output-env-file=/home/stack/templates/overcloud_images.yaml \
    --output-images-file /home/stack/local_registry_images.yaml \
    --exclude neutron-server
  when: dci_base_ip is not defined

- name: Create a template to upload the the images to the local registry
  shell: |
    source /home/stack/stackrc
    openstack overcloud container image prepare \
    --namespace={{ dci_base_ip }}:5000/rhosp13 \
    --push-destination={{ undercloud_local_ip | ipaddr('address') }}:8787 \
    --prefix=openstack- \
    --output-env-file=/home/stack/templates/overcloud_images.yaml \
    --output-images-file /home/stack/local_registry_images.yaml \
    --exclude neutron-server
  when: dci_base_ip is defined

- name: Pull the container images to the undercloud
  shell: |
    source /home/stack/stackrc
    openstack overcloud container image upload \
    --config-file /home/stack/local_registry_images.yaml \
    --verbose
  become: true

# Custom for getting networking-cisco into the neutron-server container

- name: Create the template for the neutron server images
  copy:
    dest: /usr/share/tripleo-common/container-images/overcloud_containers.yaml.j2
    backup: true
    content: |
      {% raw %}
      container_images_template:

      - imagename: "{{namespace}}/openstack-neutron-server-networking-cisco-plugin:{{tag}}"
        params:
        - DockerNeutronApiImage
        - DockerNeutronConfigImage
        services:
        - OS::TripleO::Services::NeutronApi
        - OS::TripleO::Services::NeutronDhcpAgent
        - OS::TripleO::Services::NeutronMetadataAgent
        - OS::TripleO::Services::NeutronServer
      {% endraw %}
  register: overcloud_containers
  become: true

- block:
    - name: Create a template to upload the neutron images to the local registry
      shell: |
        source /home/stack/stackrc
        openstack overcloud container image prepare \
        --namespace=registry.hub.docker.com/bradleyjones \
        --push-destination={{ undercloud_local_ip | ipaddr('address') }}:8787 \
        --tag latest \
        --output-env-file=/home/stack/templates/overcloud_images_neutron.yaml \
        --output-images-file /home/stack/local_registry_images_neutron.yaml

    - name: Pull the neutron container images to the undercloud
      shell: |
        source /home/stack/stackrc
        openstack overcloud container image upload \
        --config-file /home/stack/local_registry_images_neutron.yaml \
        --verbose
      become: true
  always:
    - name: Restore the orignal overcloud_containers template
      copy:
        dest: /usr/share/tripleo-common/container-images/overcloud_containers.yaml.j2
        src: "{{ overcloud_containers.backup_file }}"
        remote_src: true
      become: true

# CHAPTER 5. PREPARING FOR THE OVERCLOUD UPGRADE

# 5.6. DEPRECATED CLI OPTIONS

- name: Write out overcloud misc overcloud config changes
  copy:
    dest: /home/stack/environments/node-info.yaml
    content: |
      parameter_defaults:
        ControllerCount: {{ overcloud_control_scale }}
        ComputeCount: {{ overcloud_compute_scale }}
        CephStorageCount: {{ overcloud_ceph_storage_scale }}
        BlockStorageCount: {{ overcloud_block_storage_scale }}
        ObjectStorageCount: {{ overcloud_swift_storage_scale }}

# 5.11. CONFIGURING REGISTRATION FOR FAST FORWARD
# UPGRADES

- name: Write out custom ffu repo script based on guide
  copy:
    dest: /home/stack/environments/custom_repositories_script.yaml
    content: |
      parameter_defaults:
        FastForwardCustomRepoScriptContent: |
          #!/bin/bash
          set -e
          case $1 in
            ocata)
              subscription-manager repos --disable=rhel-7-server-openstack-10-rpms
              subscription-manager repos --enable=rhel-7-server-openstack-11-rpms
              ;;
            pike)
              subscription-manager repos --disable=rhel-7-server-openstack-11-rpms
              subscription-manager repos --enable=rhel-7-server-openstack-12-rpms
              ;;
            queens)
              subscription-manager repos --disable=rhel-7-server-openstack-12-rpms
              subscription-manager repos --enable=rhel-7-server-openstack-13-rpms
              subscription-manager repos --disable=rhel-7-server-rhceph-2-mon-rpms
              subscription-manager repos --enable=rhel-7-server-rhceph-3-mon-rpms
              subscription-manager repos --disable=rhel-7-server-rhceph-2-tools-rpms
              subscription-manager repos --enable=rhel-7-server-rhceph-3-tools-rpms
              ;;
            *)
              echo "unknown release $1" >&2
              exit 1
          esac

# 5.12. CHECKING CUSTOM PUPPET PARAMETERS

- name: Write out replacement for custom ml2 config parameters
  copy:
    dest: /home/stack/environments/networking-cisco-config-params.yaml
    content: |
      parameter_defaults:
        InternalApiNetworkVlanID: {{ testbed_vlan }}
        StorageNetworkVlanID: {{ storage_vlan }}
        StorageMgmtNetworkVlanID: {{ storage_mgmt_vlan }}
        TenantNetworkVlanID: {{ tenant_network_vlan }}
        EC2MetadataIp: {{ undercloud_local_ip | ipaddr('address') }}
        ControlPlaneDefaultRoute: {{ undercloud_network_gateway }}

        ExternalNetCidr: {{ overcloud_external_ip_cidr }}
        ExternalAllocationPools: [{'start': '{{ overcloud_external_ip_start }}', 'end': '{{ overcloud_external_ip_end }}'}]
        ExternalNetworkVlanID: {{ overcloud_external_vlan }}
        ExternalInterfaceDefaultRoute: {{ overcloud_external_gateway }}

        DnsServers: ["{{ dns_server_1 }}"]

        NeutronTypeDrivers: '{{ type_driver }}'
        NeutronNetworkType: '{{ network_type }}'
        NeutronNetworkVLANRanges: '{{ network_nexus_vlan_range }}'
        NeutronTunnelTypes: ''

        NetworkUCSMIp: '{{ network_ucsm_ip }}'
        NetworkUCSMUsername: '{{ network_ucsm_username }}'
        NetworkUCSMPassword: '{{ network_ucsm_password }}'
        NetworkUCSMHostList: '{{ network_ucsm_host_list }}'
        NetworkUCSMHttpsVerify: '{{ network_ucsm_https_verify }}'
        NetworkNexusConfig: {{ network_nexus_config|to_nice_json }}

        NetworkNexusManagedPhysicalNetwork: {{ network_nexus_managed_physical_network }}
        NetworkNexusVlanNamePrefix: '{{ network_nexus_vlan_name_prefix }}'
        NetworkNexusSviRoundRobin: '{{ network_nexus_svi_round_robin|to_json }}'
        NetworkNexusProviderVlanNamePrefix: '{{ network_nexus_provider_vlan_name_prefix }}'
        NetworkNexusPersistentSwitchConfig: '{{ network_nexus_persistent_switch_config|to_json }}'
        NetworkNexusSwitchHeartbeatTime: {{ network_nexus_switch_heartbeat_time }}
        NetworkNexusSwitchReplayCount: {{ network_nexus_switch_replay_count }}
        NetworkNexusProviderVlanAutoCreate: '{{ network_nexus_provider_vlan_auto_create|to_json }}'
        NetworkNexusProviderVlanAutoTrunk: '{{ network_nexus_provider_vlan_auto_trunk|to_json }}'
        NetworkNexusVxlanGlobalConfig: '{{ network_nexus_vxlan_global_config|to_json }}'
        NetworkNexusHostKeyChecks: '{{ network_nexus_host_key_checks|to_json }}'
        NeutronNetworkVLANRanges: '{{ network_nexus_vlan_range }}'
        NeutronPluginExtensions: "qos,port_security,cisco_providernet_ext"

        NetworkNexusVxlanVniRanges: '{{ vni_ranges }}'
        NetworkNexusVxlanMcastRanges: '{{ mcast_ranges }}'

        ControllerExtraConfig:
          neutron::plugins::ml2::mechanism_drivers: {{ network_cntlr_mech_drivers | to_json }}
          neutron::config::plugin_ml2_config: {{ extra_neutron_config_osp13 | to_json }}

        NovaComputeExtraConfig:
          neutron::plugins::ml2::mechanism_drivers: ['openvswitch']

        NetConfigDataLookup: {{ overcloud_node_nic_mappings_bond | to_nice_json }}

        # Format for node hostnames Note %index% is translated into the index
        # of the node, e.g 0/1/2 etc and %stackname% is replaced with the stack
        # name e.g overcloud
        ComputeHostnameFormat: '{{ overcloud_node_prefix }}-%stackname%-compute-%index%'
        ControllerHostnameFormat: '{{ overcloud_node_prefix }}-%stackname%-controller-%index%'

# CHAPTER 6. UPGRADING THE OVERCLOUD

# 6.1. PERFORMING THE FAST FORWARD UPGRADE OF THE
# OVERCLOUD

- name: Run the fast forward upgrade preparation command
  shell: |
    source /home/stack/stackrc
    openstack overcloud ffwd-upgrade prepare --yes --templates \
        -e /home/stack/environments/node-info.yaml \
        -e /home/stack/templates/overcloud_images.yaml \
        -e /home/stack/templates/overcloud_images_neutron.yaml \
        -e /usr/share/openstack-tripleo-heat-templates/environments/network-isolation.yaml \
        -e /usr/share/openstack-tripleo-heat-templates/environments/net-bond-with-vlans.yaml \
        -e /home/stack/environments/networking-cisco-config-resources-preupgrade.yaml \
        -e /home/stack/environments/networking-cisco-config-params.yaml \
        -e /home/stack/environments/custom_repositories_script.yaml \
        --ntp-server 1.ntp.esl.cisco.com

- name: Run the fast forward upgrade command
  shell: |
    source /home/stack/stackrc
    openstack overcloud ffwd-upgrade run --yes

# 6.2. UPGRADING ALL CONTROLLER NODES

- name: Run the upgrade command
  shell: |
    source /home/stack/stackrc
    openstack overcloud upgrade run --roles Controller --skip-tags validation

# 6.4. UPGRADING ALL COMPUTE NODES

- name: Run the upgrade command
  shell: |
    source /home/stack/stackrc
    openstack overcloud upgrade run --roles Compute --skip-tags validation

# 6.6. FINALIZING THE FAST FORWARD UPGRADE

- name: Run the fast forward upgrade finalization command
  shell: |
    source /home/stack/stackrc
    openstack overcloud ffwd-upgrade converge --yes --templates \
        -e /home/stack/environments/node-info.yaml \
        -e /home/stack/templates/overcloud_images.yaml \
        -e /home/stack/templates/overcloud_images_neutron.yaml \
        -e /usr/share/openstack-tripleo-heat-templates/environments/network-isolation.yaml \
        -e /usr/share/openstack-tripleo-heat-templates/environments/net-bond-with-vlans.yaml \
        -e /home/stack/environments/networking-cisco-config-resources-preupgrade.yaml \
        -e /home/stack/environments/networking-cisco-config-params.yaml \
        -e /home/stack/environments/custom_repositories_script.yaml \
        --ntp-server 1.ntp.esl.cisco.com

# CHAPTER 7. EXECUTING POST UPGRADE STEPS

# 7.3. UPGRADING THE OVERCLOUD IMAGES

- name: Unpack the overcloud images into stack
  unarchive:
    remote_src: true
    src: "{{ item }}"
    dest: /home/stack/images
  with_items:
    - /usr/share/rhosp-director-images/overcloud-full-latest-13.0.tar
    - /usr/share/rhosp-director-images/ironic-python-agent-latest-13.0.tar

- name: Upload overcloud images to the undercloud
  shell: |
    source /home/stack/stackrc
    openstack overcloud image upload --update-existing --image-path /home/stack/images/
    openstack overcloud node configure $(openstack baremetal node list -c UUID -f value)


# TODO(sambetts) Add code to reenable unsubscription from RHEL on delete
