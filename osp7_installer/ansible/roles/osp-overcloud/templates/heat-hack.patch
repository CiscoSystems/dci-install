From 85e55a85cae6755562403fdf01a1b9ac01fc75b7 Mon Sep 17 00:00:00 2001
From: tiswanso <tiswanso@cisco.com>
Date: Thu, 10 Sep 2015 12:17:20 -0400
Subject: [PATCH 1/1] Hack for updating plugin.ini rather than
 /etc/neutron/conf.d/neutron-server/*.ini with nexus config

---
 puppet/manifests/overcloud_controller.pp           | 10 ++++++++++
 puppet/manifests/overcloud_controller_pacemaker.pp | 10 ++++++++++
 2 files changed, 20 insertions(+)

diff --git puppet/manifests/overcloud_controller.pp puppet/manifests/overcloud_controller.pp
index 8bb5148..6bf2aee 100644
--- puppet/manifests/overcloud_controller.pp
+++ puppet/manifests/overcloud_controller.pp
@@ -249,6 +249,16 @@ if hiera('step') >= 3 {
   if 'cisco_nexus' in hiera('neutron_mechanism_drivers') {
     include ::neutron::plugins::ml2::cisco::nexus
     include ::neutron::plugins::ml2::cisco::type_nexus_vxlan
+
+    # hack to put nexus_config into /etc/neutron/plugin.ini due to 
+    # neutron config-dir functionality not working
+    exec { "ml2_cisco_nexus_conf_hack":
+        path => "/usr/bin:/bin",
+        command => "cat /etc/neutron/conf.d/neutron-server/ml2_mech_cisco_nexus.ini >> /etc/neutron/plugin.ini",
+        subscribe => File["nexus_config"],
+        refreshonly => true,
+    } ~> Service['neutron-server']
+
   }
 
   Service['neutron-server'] -> Service['neutron-dhcp-service']
diff --git puppet/manifests/overcloud_controller_pacemaker.pp puppet/manifests/overcloud_controller_pacemaker.pp
index a3c464a..5c80068 100644
--- puppet/manifests/overcloud_controller_pacemaker.pp
+++ puppet/manifests/overcloud_controller_pacemaker.pp
@@ -611,6 +611,16 @@ if hiera('step') >= 3 {
   if 'cisco_nexus' in hiera('neutron_mechanism_drivers') {
     include ::neutron::plugins::ml2::cisco::nexus
     include ::neutron::plugins::ml2::cisco::type_nexus_vxlan
+
+    # hack to put nexus_config into /etc/neutron/plugin.ini due to 
+    # neutron config-dir functionality not working
+    exec { "ml2_cisco_nexus_conf_hack":
+        path => "/usr/bin:/bin",
+        command => "cat /etc/neutron/conf.d/neutron-server/ml2_mech_cisco_nexus.ini >> /etc/neutron/plugin.ini",
+        subscribe => File["nexus_config"],
+        refreshonly => true,
+    } ~> Service['neutron-server']
+
   }
 
   include ::cinder
-- 
1.9.1

